# Веб-интерфейс TradeForge

## Обзор

- Веб-интерфейс TradeForge надстраивается над песочницей-бэкендом и позволяет настраивать симуляции биржи, запускать, приостанавливать и останавливать исполнение, подключать собственные боты и наблюдать за балансами в реальном времени.
- Текущий MVP рассчитан на одного локального оператора и допускает только один активный запуск одновременно. Балансы ведутся по каждому боту; позиции, атрибуция PnL и многопользовательские сценарии в этой версии отсутствуют.

## Предварительные требования

- Node.js версии 20 или новее (проверьте командой `node -v`).
- Установленный инструментарий pnpm workspace.
- Склонируйте репозиторий и один раз установите зависимости из корневой директории:

  ```bash
  pnpm -w i
  ```

## Запуск сервисов

> **Примечание о скорости запуска.** Параметр `speed` задаётся на этапе предварительной конфигурации через `POST /v1/runs` и работает только в историческом режиме. Метод `POST /v1/runs/start` просто запускает симуляцию с уже сохранёнными параметрами и не принимает поле `speed` в теле запроса.

1. **Запустите бэкенд (сервис Fastify).**

   ```bash
   cd apps/svc
   pnpm dev
   ```

   - По умолчанию сервис слушает `http://localhost:3001`. При необходимости переопределите `PORT` и/или `HOST`.
   - Задайте `RUNS_DIR`, чтобы изменить каталог, в котором сохраняются артефакты запусков (конфигурации, ордера, сделки, балансы). По умолчанию они попадают в `<repo>/runs/`.
   - Если UI обслуживается с другого происхождения, определите `CORS_ORIGIN` (список адресов через запятую, например `http://localhost:5173`). Если переменная не задана, dev-сервер автоматически разрешает стандартное происхождение UI.

2. **Запустите фронтенд (React/Vite UI).**

   ```bash
   cd apps/web
   pnpm dev
   ```

   - Dev-сервер Vite работает на `http://localhost:5173`.
   - Настройте маршрутизацию к API, добавив файл `.env` (или `.env.local`) рядом с `apps/web` и указав:

     ```bash
     VITE_API_BASE=http://localhost:3001
     ```

     > **Комиссии и целочисленные поля**
     >
     > - Комиссии указываются в **базисных пунктах** (целые числа): `makerBp: 1`, `takerBp: 5`.
     > - Денежные суммы и количества, оканчивающиеся на `Int`, — это **строки** в минимальных единицах (безопасны для JSON).
     >
     > Используйте переменную `VITE_API_BASE`, если бэкенд доступен по нестандартному URL, в контейнере или через туннель.

## Работа с веб-интерфейсом

1. Откройте в браузере `http://localhost:5173`.
2. Стартовая страница разделена на три панели:

   <!-- TODO: добавить скриншот интерфейса -->

   ### Предварительная конфигурация
   - Выберите **Биржу** и **Оператора данных**, чтобы описать источник данных песочницы.
   - Установите **Режим запуска** (`Realtime` или `History`). Исторический режим открывает выбор диапазона дат и управление скоростью воспроизведения. Скорость задаётся при конфигурации запуска (`POST /v1/runs`) и действует только в режиме истории.
   - Управляйте строками инструментов, чтобы определить тикеры и их комиссии мейкера/тейкера в базисных пунктах. Добавляйте дополнительные строки для мультиактивных симуляций.
   - Настройте операционные лимиты, такие как **Максимум активных ордеров** и **Таймаут heartbeat (сек)**.
   - Включите **Статус данных**, когда исторический набор данных готов к запуску.
   - Нажмите **Применить**, чтобы отправить конфигурацию в `/v1/runs`.

     ```bash
     curl -X POST http://localhost:3001/v1/runs \
       -H "Content-Type: application/json" \
       -d '{
         "id": "run-20240101",
         "mode": "history",
         "speed": "1x",
         "exchange": "Binance",
         "dataOperator": "Internal",
         "instruments": [
           {
             "symbol": "BTCUSDT",
             "fees": { "makerBp": 1, "takerBp": 1 }
           }
         ],
         "maxActiveOrders": 100,
         "heartbeatTimeoutSec": 10,
         "dataReady": true
       }'
     ```

   ### Управление запуском
   - Строка статуса отражает `GET /v1/runs/status` и обновляется каждые пять секунд.
   - **Старт** вызывает `POST /v1/runs/start`, чтобы продолжить выполнение с ранее заданными параметрами.
   - **Пауза** (`POST /v1/runs/pause`) и **Стоп** (`POST /v1/runs/stop`) аккуратно сохраняют состояние, чтобы позже можно было продолжить или проиграть запуск заново.

   ### Панель ботов
   - Отображает подключённых ботов с их исходным балансом и последней моментальной копией баланса.
   - Балансы транслируются через WebSocket-сообщения `balance.update`; при переподключении бот сохраняет прежние балансы и историю.

## Подключение ботов

> **Идентификация и авторизация (MVP).** Токены и авторизация отсутствуют. Бот идентифицируется по полю `botName`. После отключения состояние сохраняется; повторное подключение с тем же **`botName`** возобновляет сессию. Избегайте конфликтов имён, если тестируют несколько человек.
>
> **Метка времени в конверте (`ts`).** В примерах используется `ts` (миллисекунды эпохи) для трассировки; сервер может игнорировать значение.

### Жизненный цикл сессии

Боты подключаются к `ws://localhost:3001/ws`. Используйте защищённое соединение (`wss://`), если проксируете через TLS. Сразу после открытия соединения отправьте конверт `hello`. Количества, цены и балансы в целых числах следует кодировать строками, чтобы сохранить точность.

```json
{
  "type": "hello",
  "ts": 1700000000000,
  "payload": {
    "botName": "alpha-maker",
    "initialBalanceInt": "100000000"
  }
}
```

Сервис отвечает `hello` с описанием настроенных символов, комиссий и лимитов запуска:

```json
{
  "type": "hello",
  "ts": 1700000000000,
  "payload": {
    "symbols": ["BTCUSDT"],
    "fees": {
      "BTCUSDT": { "maker": 1, "taker": 1 }
    },
    "limits": { "maxActiveOrders": 100 }
  }
}
```

### Heartbeat

> **Примечание о метке времени.** Примеры могут включать `ts` (миллисекунды эпохи). Допустимы варианты как с `ts`, так и без него; метка рекомендуется для трассировки.

Поддерживайте соединение в живом состоянии, отправляя heartbeat быстрее, чем заданный `heartbeatTimeoutSec`:

```json
{ "type": "heartbeat", "ts": 1700000000000, "payload": {} }
```

Сервер отвечает собственным `heartbeat` и пишет предупреждение в лог, если heartbeats от бота прекращаются.

### Ордеры

Размещайте ордера через WebSocket:

```json
{
  "type": "order.place",
  "ts": 1700000000000,
  "payload": {
    "clientOrderId": "c_170...",
    "symbol": "BTCUSDT",
    "side": "buy",
    "type": "MARKET|LIMIT|STOP_MARKET|STOP_LIMIT",
    "qtyInt": "1",
    "priceInt": "100",
    "stopPriceInt": "100",
    "limitPriceInt": "101",
    "timeInForce": "GTC",
    "flags": ["postOnly"]
  }
}
```

> **Источник триггера для STOP.** STOP-ордера (stop-market/stop-limit) активируются по цене **последней сделки**, а не по лучшему бид/аск.

Успешная отправка генерирует:

- `order.ack` с присвоенным `serverOrderId` и результатом приёма.
- `order.update`, когда ордер переходит в состояние `open`, `filled` или `canceled`.
- `order.fill` и запись `trade` для исполненного объёма с учётом рассчитанных комиссий тейкера/мейкера.

### Отмена ордера

```json
{
  "type": "order.cancel",
  "ts": 1700000000000,
  "payload": { "serverOrderId": "o_123" }
}
```

### Отказы (структурированные коды)

```json
{
  "type": "order.reject",
  "ts": 1700000000000,
  "payload": {
    "code": "VALIDATION",
    "message": "bad order payload",
    "clientOrderId": "c_170..."
  }
}
```

```json
{
  "type": "order.reject",
  "ts": 1700000000000,
  "payload": { "code": "RATE_LIMIT", "message": "too many active orders" }
}
```

Успешная отмена возвращает `order.cancel` с тем же `serverOrderId`; при ошибках приходят `order.reject` с кодами `NOT_FOUND`, `RATE_LIMIT`, `VALIDATION` и т.д.

### Обновления баланса

Изменения балансов приходят сообщениями `balance.update`. Бэкенд сохраняет состояние бота, поэтому переподключение с тем же `botName` восстанавливает балансы и активные ордера.

### Трансляция глубины рынка (L2)

- При подписке/подключении сервер отправляет полный **снимок** стакана L2 по каждому настроенному символу:

```json
{
  "type": "depth.snapshot",
  "ts": 1700000000000,
  "payload": {
    "symbol": "BTCUSDT",
    "bids": [["100000", "2"]],
    "asks": [["100100", "1"]]
  }
}
```

- Затем транслируются **диффы** без агрегации:

```json
{
  "type": "depth.diff",
  "ts": 1700000000000,
  "payload": {
    "symbol": "BTCUSDT",
    "bids": [["100000", "0"]],
    "asks": [["100200", "3"]]
  }
}
```

`qtyInt == "0"` означает удаление ценового уровня.

### Сводка сообщений WebSocket

| Направление  | Типы сообщений                                                            | Назначение                                                    |
| ------------ | ------------------------------------------------------------------------- | ------------------------------------------------------------- |
| бот → сервер | `hello`, `heartbeat`, `order.place`, `order.cancel`                       | Идентификация бота, поддержание сессии и управление ордерами. |
| сервер → бот | `hello`, `heartbeat`                                                      | Подтверждение конфигурации запуска и контроль активности.     |
| сервер → бот | `order.ack`, `order.update`, `order.fill`, `order.cancel`, `order.reject` | Отражение жизненного цикла ордеров и связанных ошибок.        |
| сервер → бот | `balance.update`, `depth.snapshot`, `depth.diff`                          | Трансляция изменений балансов и стаканов L2.                  |

## Хранение и результаты

### Персистентность

- Артефакты сохраняются в `runs/{runId}/` (каталог можно изменить через `RUNS_DIR`).
- Запись производится **атомарно** (сначала во временный файл, затем переименование), чтобы исключить усечённые файлы при сбоях.

### Состав артефактов

- `run.json` — снимок конфигурации и временные метки жизненного цикла.
- `metadata.json` — сведения о бирже и настройках heartbeat.
- `orders.json` / `trades.json` — хронологическая история ордеров и сделок.
- `balances.json` — балансы ботов на момент последнего сохранения.
- Повторно запускать исторические симуляции можно, переиспользуя сохранённую конфигурацию через `POST /v1/runs` и указывая ботам сохранённый набор данных.

## Примеры

- Минимальный эмулятор бота на Node.js находится в [`docs/snippets/bot.js`](snippets/bot.js):

  ```javascript
  // Минимальный эмулятор бота, демонстрирующий протокол и коды
  const WS = require('ws');

  const url = process.env.WS_URL || 'ws://localhost:3001/ws';
  const ws = new WS(url);

  ws.on('open', () => {
    console.log('[bot] connected to', url);
    ws.send(
      JSON.stringify({
        type: 'hello',
        ts: Date.now(),
        payload: { botName: 'demo-bot', initialBalanceInt: '100000000' },
      }),
    );

    setInterval(() => {
      ws.send(
        JSON.stringify({ type: 'heartbeat', ts: Date.now(), payload: {} }),
      );
    }, 2000);

    setInterval(() => {
      ws.send(
        JSON.stringify({
          type: 'order.place',
          ts: Date.now(),
          payload: {
            clientOrderId: `c_${Date.now()}`,
            symbol: 'BTCUSDT',
            side: 'buy',
            type: 'MARKET',
            qtyInt: '1',
            priceInt: '100',
            timeInForce: 'GTC',
          },
        }),
      );
    }, 5000);
  });

  ws.on('message', (raw) => {
    try {
      const message = JSON.parse(raw.toString());
      if (message.type === 'order.reject') {
        console.log('REJECT', message.payload.code, message.payload.message);
      } else {
        console.log('<<', message.type, message.payload);
      }
    } catch (error) {
      console.error('[bot] failed to parse', error);
    }
  });

  ws.on('close', () => {
    console.log('[bot] disconnected');
  });

  ws.on('error', (error) => {
    console.error('[bot] error', error);
  });
  ```

  Запустите его из корня репозитория:

  ```bash
  node docs/snippets/bot.js
  ```

  В консоли появятся сообщения о рукопожатии `hello`, событиях `order.ack`/`order.fill` и дельтах `balance.update`. Веб-интерфейс покажет, как баланс `demo-bot` уменьшается с каждой смоделированной покупкой.

## Устранение неполадок

- **Ошибки CORS в консоли браузера.** Убедитесь, что `CORS_ORIGIN` на бэкенде включает происхождение UI и что `VITE_API_BASE` указывает на правильный адрес бэкенда.
- **Отказы `RATE_LIMIT`.** Увеличьте `maxActiveOrders` на панели Предварительной конфигурации или дождитесь завершения активных ордеров перед отправкой новых.
- **Отказы `VALIDATION`.** Проверьте полезные нагрузки: целочисленные поля (`*_Int`) должны быть строками с целыми числами, обязательные идентификаторы присутствуют, а символы существуют в текущем запуске.
- **Балансы не отображаются.** Убедитесь, что боты отправляют периодические heartbeats, и проверьте, нет ли в логах бэкенда предупреждений о тайм-аутах heartbeat.
