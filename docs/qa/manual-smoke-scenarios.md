# Ручные smoke-сценарии TradeForge (history + realtime)

Документ фиксирует повторяемые шаги проверки для быстрой регрессии UI/REST: подготовка запуска, воспроизведение истории и real-time, смена инструмента, размещение ордеров и контроль ошибок.

## Предусловия

- Бэкенд: `cd apps/svc && pnpm dev` (по умолчанию `http://localhost:3001`).
- UI: `cd apps/web && pnpm dev` (`http://localhost:5173`, `VITE_API_BASE=http://localhost:3001`).
- WebSocket статус в шапке UI должен переключиться в `Онлайн`.
- Историчный набор данных доступен локально (можно использовать мини-фикстуры или подготовленный JSONL), продакшн ключи для realtime — валидны и с нужными правами.

## Сценарий 1. Быстрый прогон в history-режиме

1. **Подключение и конфигурация.** В секции _Предварительная конфигурация_ выберите `History`, биржу, оператора данных и в таблице инструментов оставьте базовый тикер (по умолчанию `BTCUSDT`) с комиссиями maker/taker. Нажмите `Загрузить`, задав диапазон дат, и убедитесь, что статус данных сменился на `Готово`. Затем `Применить конфигурацию`.
   - _Ожидание:_ UI показывает «Конфигурация обновлена», `/v1/runs/status` отражает `mode: history` и `status: idle`.
2. **Выбор скорости.** В блоке _Управление запуском_ убедитесь, что селектор скорости активен и установлен, например, в `1x`.
   - _Ожидание:_ значение `speed` в `/v1/runs/status` меняется после старта.
3. **Старт воспроизведения.** Нажмите `Старт`. Дождитесь, пока статус обновится до `running`.
   - _Ожидание:_ В логах `apps/svc` появляется `run transition` со статусом `running`; UI отображает `Текущий статус: running`.
4. **Переключение инструмента.** Остановите запуск кнопкой `Стоп`, в таблице инструментов замените тикер на другой (например, `ETHUSDT`) и снова `Применить конфигурацию`, затем `Старт`.
   - _Ожидание:_ Новый тикер присутствует в конфигурации `/v1/runs/status`; запуск переключается на обновлённый инструмент без ошибок при старте.
5. **Размещение ордеров.**
   1. Создайте аккаунт и внесите депозит:
      ```bash
      curl -sX POST http://localhost:3001/v1/accounts | jq -r '.accountId'
      curl -sX POST http://localhost:3001/v1/accounts/<ACCOUNT_ID>/deposit \
        -H "Content-Type: application/json" \
        -d '{"currency":"USDT","amount":"1000"}'
      ```
   2. Отправьте market и limit-ордеры на активный тикер:
      ```bash
      curl -sX POST http://localhost:3001/v1/orders \
        -H "Content-Type: application/json" \
        -d '{"accountId":"<ACCOUNT_ID>","symbol":"ETHUSDT","type":"MARKET","side":"BUY","qty":"0.1"}'
      curl -sX POST http://localhost:3001/v1/orders \
        -H "Content-Type: application/json" \
        -d '{"accountId":"<ACCOUNT_ID>","symbol":"ETHUSDT","type":"LIMIT","side":"SELL","qty":"0.1","price":"3000"}'
      ```
   - _Ожидание:_ Первый ордер исполняется по ближайшей сделке; второй остаётся в `/v1/orders/open` до достижения цены. Балансы `/v1/accounts/<id>/balances` отражают изменение позиции и удержание/возврат средств после исполнения.

## Сценарий 2. Повтор в realtime-режиме

1. **Переключение режима.** В UI выберите `Realtime`; `dataReady` автоматически станет `Готово`. Убедитесь, что указаны реальные ключи/параметры соединения (если используются переменные окружения сервиса).
   - _Ожидание:_ `/v1/runs/status` после применения конфигурации показывает `mode: realtime` и `status: idle`.
2. **Старт realtime.** Нажмите `Старт` без указания скорости. Отслеживайте, что статус переходит в `running`, а в логах `apps/svc` нет ошибок соединения.
3. **Смена инструмента на лету.** Остановите запуск (`Стоп`), замените тикер в таблице инструментов (например, с `BTCUSDT` на `ETHUSDT`), примените конфигурацию и снова запустите.
   - _Ожидание:_ При новом старте WebSocket подписка проходит успешно, reconnect-попытки не превышают ожидаемый лимит.
4. **Размещение ордеров.** Повторите шаг с созданием аккаунта/депозита, затем отправьте market и limit-ордеры на новый тикер (аналогично шагу 5 сценария history).
   - _Ожидание:_ Market-ордер исполняется по входящим real-time сделкам; limit остаётся активным до прихода подходящей цены. Баланс обновляется в UI (таблица «Активные боты») и через REST.

## Проверка логов и консоли

- **Бэкенд (`apps/svc`)**: в процессе сценариев отсутствуют записи уровня `error`/`fatal`; сообщения `failed to start realtime scheduler` или `RUN_NOT_CONFIGURED` не появляются.
- **Браузерная консоль**: нет uncaught exceptions, WebSocket не переходит в `closed` сразу после старта.
- **REST-ответы**: все вызовы возвращают 2xx; ошибки валидации (`400`) допускаются только при сознательно неправильных вводах.

## Что должно считаться успешным прогоном

- Конфигурации history и realtime применяются без ошибок, статус `running` достигается в обоих режимах.
- Смена инструмента после стопа приводит к обновлению конфигурации и повторному успешному старту.
- Market-ордер исполняется, limit остаётся открытым до достижения цены; балансы отражают изменения.
- Логи и консоль чисты от критичных ошибок.
