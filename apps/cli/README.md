# @tradeforge/cli

Командная строка TradeForge предназначена для локальных прогонов симулятора на исторических данных Binance. После сборки пакет предоставляет бинарь `tf`.

```bash
pnpm install
pnpm --filter @tradeforge/cli build
pnpm --filter @tradeforge/cli exec -- tf --version
```

## Команда `tf simulate`

`tf simulate` запускает консервативный матчинг ордеров поверх потока сделок и (опционально) стакана. В стандартном режиме команда печатает два JSON-объекта: метаданные прогона (`clock`, число обработанных событий и длительности) и агрегированную сводку по счетам/ордерам. Все числовые поля сериализуются в строки, чтобы сохранить точность `bigint`.

### Источники данных

- `--trades <path>[,<path>...]` — список файлов со сделками. Поддерживаются `*.jsonl`, `*.jsonl.gz`, `*.jsonl.zip`, `*.json`, `*.ndjson`, `*.csv`. Для `*.jsonl*` доступны курсоры и возобновляемые чекпоинты.
- `--depth <path>[,<path>...]` — список файлов с изменениями стакана. Необязательны; в MVP-1 данные стакана не влияют на исполнение, но участвуют в тай-брейке при совпадении меток времени.
- `--symbol <SYMBOL>` — идентификатор инструмента (по умолчанию `BTCUSDT`). При возобновлении из чекпоинта символ берётся из снимка.
- `--format-trades/--format-depth <auto|csv|json|jsonl>` — явное указание формата, если расширение файла вводит в заблуждение.
- `--from` / `--to` — ограничение диапазона по времени. Принимают Unix-миллисекунды или строки, которые понимает `Date.parse`.
- `--limit <N>` — ограничивает число распечатанных отчётов при `--ndjson`.

### Управление исполнением

- `--clock <logical|wall|accel>` — тип часов. Логические часы не зависят от wall-clock. Wall-clock синхронизирован с реальным временем. `accel` включает ускоренные часы; множитель задаётся через `--speed` (>=1).
- `--speed <FACTOR>` — ускорение для `--clock accel`. По умолчанию `10`.
- `--max-events <N>` — жёсткий лимит на количество событий, после которого симуляция останавливается.
- `--max-sim-ms <MS>` — ограничение виртуального времени (разница меток сделок) в миллисекундах.
- `--max-wall-ms <MS>` — ограничение по реальному времени выполнения.
- `--pause-on-start` — старт в паузе. CLI ожидает нажатия Enter перед продолжением, что удобно при запуске из терминала с долгим прогревом.
- `--prefer-depth-on-equal-ts` — управляет tie-break при одинаковых метках времени (по умолчанию стакан приоритетнее).
- `--treat-limit-as-maker` — опция консервативного режима (по умолчанию `true`), позволяющая симулятору считать лимитные заявки поставщиком ликвидности.
- `--strict-conservative` — отключает участие в сделках, где нет уверенности в ликвидности со стороны агрессора (`participationFactor = 0`).
- `--use-aggressor-liquidity` — разрешает использовать объём агрессора для частичного матчинга (по умолчанию выключено).

### Вывод

- `--ndjson` — печатать каждый отчёт исполнения (execution report) отдельной строкой в формате NDJSON.
- `--summary` / `--no-summary` — включает/выключает финальный агрегированный отчёт (по умолчанию печатается).

### Работа с чекпоинтами

- `--checkpoint-save <FILE>` — путь к файлу, в который будет сохраняться снимок состояния (`CheckpointV1`).
- `--cp-interval-events <N>` — сохранять чекпоинт каждые `N` обработанных событий.
- `--cp-interval-wall-ms <MS>` — альтернативный интервал автосохранения по wall-clock времени.
- `--checkpoint-load <FILE>` — возобновить симуляцию из ранее сохранённого чекпоинта. Для корректного продолжения необходимо передать те же входные файлы, что использовались при сохранении (минимум JSONL для гарантированной поддержки курсоров).

Чекпоинт содержит сериализованное состояние движка, курсоры по потокам сделок/стакана и флаг tie-break. Файл сохраняется в JSON с `bigint`, сериализованными в строки.

### Типовые сценарии

1. **Базовый прогон**

   ```bash
   pnpm --filter @tradeforge/cli exec -- \
     tf simulate \
     --trades data/trades.jsonl \
     --depth data/depth.jsonl
   ```

2. **Автосохранение чекпоинтов** — сохраняем снимок каждые 10 000 событий или каждые 60 с реального времени:

   ```bash
   pnpm --filter @tradeforge/cli exec -- \
     tf simulate \
     --trades data/trades.jsonl \
     --checkpoint-save checkpoints/btcusdt.json \
     --cp-interval-events 10000 \
     --cp-interval-wall-ms 60000
   ```

3. **Возобновление из чекпоинта** — продолжаем с того же места, где остановились:

   ```bash
   pnpm --filter @tradeforge/cli exec -- \
     tf simulate \
     --checkpoint-load checkpoints/btcusdt.json \
     --trades data/trades.jsonl \
     --depth data/depth.jsonl
   ```

   Если чекпоинт содержит курсоры `trades`/`depth`, необходимо снова указать исходные JSONL-файлы.

4. **Пауза перед стартом** — запускаем с интерактивной паузой и ускоренными часами:
   ```bash
   pnpm --filter @tradeforge/cli exec -- \
     tf simulate \
     --trades data/trades.jsonl \
     --clock accel \
     --speed 50 \
     --pause-on-start
   ```

## Возобновление через CLI

Типовой user-flow: запускаем симуляцию с `--checkpoint-save`, дожидаемся автосохранения (`checkpoint saved to …`), прекращаем процесс и затем продолжаем с помощью `--checkpoint-load`. Для устойчивого возобновления используйте JSONL источники: только они гарантируют корректное восстановление курсора по файлам.
